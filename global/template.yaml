AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'myECM Global Setup'


## Bucket names - override in sam deploy for custom names
Parameters:
  TPBucketName:
    Type: String
    Default: 'myecm-s3-tp'
  BATCHBucketName:
    Type: String
    Default: 'myecm-s3-batch'
  LogsBucketName:
    Type: String
    Default: 'myecm-s3-logs'

## S3 buckets
Resources:
  TPBucket:
    Type: AWS::S3::Bucket  
    Properties:
      BucketName: !Ref TPBucketName
  BATCHBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref BATCHBucketName
  LogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref LogsBucketName

# Bucket policy enables CloudTrail to write to the logging bucket
  BucketPolicy: 
    Type: AWS::S3::BucketPolicy
    Properties: 
      Bucket: 
        Ref: LogsBucket
      PolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          - Sid: "AWSCloudTrailAclCheck"
            Effect: "Allow"
            Principal: 
              Service: "cloudtrail.amazonaws.com"
            Action: "s3:GetBucketAcl"
            Resource: 
              !Sub 'arn:aws:s3:::${LogsBucket}'
          - Sid: "AWSCloudTrailWrite"
            Effect: "Allow"
            Principal: 
              Service: "cloudtrail.amazonaws.com"
            Action: "s3:PutObject"
            Resource:
              !Sub 'arn:aws:s3:::${LogsBucket}/AWSLogs/${AWS::AccountId}/*'
            Condition: 
              StringEquals:
                s3:x-amz-acl: "bucket-owner-full-control"

  # The CloudTrail trail - uses the LogsBucketName as the trail name
  # Specify the buckets you want to monitor in the EventSelectors Values array

  myTrail: 
    Type: AWS::CloudTrail::Trail
    DependsOn: 
      - BucketPolicy
    Properties: 
      TrailName: !Ref LogsBucketName
      S3BucketName: 
        Ref: LogsBucket
      IsLogging: true
      IsMultiRegionTrail: false
      EventSelectors:
        - IncludeManagementEvents: false
          DataResources:
          - Type: AWS::S3::Object
            Values:
              - !Sub 'arn:aws:s3:::${TPBucketName}/'
              - !Sub 'arn:aws:s3:::${BATCHBucketName}/'
      IncludeGlobalServiceEvents: false

# Used by any target functions to access the S3
# buckets. If more buckets need to be added, add here
# instead of at each function.

  MyManagedPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: indexation-buckets-read-policy
      PolicyDocument: 
        Version: 2012-10-17
        Statement: 
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:ListBucket
              - s3:GetBucketLocation
              - s3:GetObjectVersion
              - s3:GetLifecycleConfiguration
            Resource:
              - !Sub 'arn:aws:s3:::${TPBucket}/*'
              - !Sub 'arn:aws:s3:::${BATCHBucket}/*'

## Outputs
Outputs: 
  TPBucketName:
    Description: TP Indexation Bucket
    Value: !Ref TPBucket
  BATCHBucketName:
    Description: BATCH Indexation Bucket
    Value: !Ref BATCHBucket
  LogsBucketName:
    Description: Logs Bucket 
    Value: !Ref LogsBucket      